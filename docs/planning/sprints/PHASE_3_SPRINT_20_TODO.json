{
  "phase": 4,
  "sprint": 20,
  "title": "Spillover and Diversity",
  "priority": "MEDIUM",
  "effort": "5 hours",
  "status": "completed",
  "completedAt": "2026-01-13",
  "implementationNotes": "Added spillover handling with handleSpillover() for tracking excluded content with pagination cursors and suggestions. Implemented diversity enforcement with enforceDiversity(), calculateDiversityScore(), and configurable diversityThreshold. Added getMostSalient() with heap-based O(n log k) selection and calculateEntitySimilarity(). Created MemoryFormatter class with formatForPrompt(), formatAsJSON(), formatCompact(), formatByType(), formatSummary(). Integrated SalienceEngine, ContextWindowManager, and MemoryFormatter into ManagerContext with environment variable configuration. 34 new tests (5 SalienceEngine + 10 ContextWindowManager + 19 MemoryFormatter).",
  "impact": "Handles context overflow and ensures retrieval diversity",
  "targetMetrics": {
    "spilloverTracking": {
      "current": "No overflow handling",
      "target": "Full tracking with suggestions"
    },
    "diversityScore": {
      "current": "Possible redundancy",
      "target": "Minimal redundancy in context"
    }
  },
  "tasks": [
    {
      "id": "4.20.1",
      "category": "core",
      "title": "Implement handleSpillover() Method",
      "description": "Track excluded content when budget exceeded, generate suggestions for follow-up retrieval, enable pagination patterns.",
      "status": "completed",
      "estimatedHours": 1.0,
      "agent": "claude",
      "files": ["src/agent/ContextWindowManager.ts"],
      "acceptanceCriteria": [
        "Excluded content tracked",
        "Suggestions generated",
        "Pagination support",
        "Priority preserved"
      ]
    },
    {
      "id": "4.20.2",
      "category": "core",
      "title": "Implement Diversity Enforcement",
      "description": "Detect similarity between included memories and replace duplicates with diverse alternatives.",
      "status": "completed",
      "estimatedHours": 1.25,
      "agent": "claude",
      "files": ["src/agent/ContextWindowManager.ts"],
      "acceptanceCriteria": [
        "Similarity detection works",
        "Duplicates replaced",
        "Diversity maintained",
        "Configurable threshold"
      ]
    },
    {
      "id": "4.20.3",
      "category": "core",
      "title": "Add getMostSalient() to SalienceEngine",
      "description": "Convenience method returning top N most salient entities using heap-based selection for efficiency.",
      "status": "completed",
      "estimatedHours": 0.75,
      "agent": "claude",
      "files": ["src/agent/SalienceEngine.ts"],
      "acceptanceCriteria": [
        "Returns top N entities",
        "Heap-based for O(n log k)",
        "Context-aware scoring",
        "Efficient implementation"
      ]
    },
    {
      "id": "4.20.4",
      "category": "core",
      "title": "Create Memory Formatting Utilities",
      "description": "Format memories for LLM consumption with formatForPrompt() and formatAsJSON() respecting token limits.",
      "status": "completed",
      "estimatedHours": 1.0,
      "agent": "claude",
      "files": ["src/agent/MemoryFormatter.ts"],
      "acceptanceCriteria": [
        "Prompt format works",
        "JSON format works",
        "Token limits respected",
        "Customizable templates"
      ]
    },
    {
      "id": "4.20.5",
      "category": "integration",
      "title": "Add ContextWindowManager and SalienceEngine to ManagerContext",
      "description": "Lazy-initialize both, expose via ctx.contextWindow and ctx.salienceEngine, add env vars for config.",
      "status": "completed",
      "estimatedHours": 1.0,
      "agent": "claude",
      "files": ["src/core/ManagerContext.ts"],
      "acceptanceCriteria": [
        "Both accessible via context",
        "Lazy initialization works",
        "Env var configuration",
        "Integration tests pass"
      ]
    }
  ],
  "successCriteria": [
    "Spillover handled with suggestions",
    "Diversity enforced in context",
    "getMostSalient efficient",
    "Formatting utilities work",
    "Managers in ManagerContext",
    "10+ unit tests pass"
  ],
  "filesCreated": ["src/agent/MemoryFormatter.ts"],
  "filesModified": ["src/agent/ContextWindowManager.ts", "src/agent/SalienceEngine.ts", "src/core/ManagerContext.ts", "src/agent/index.ts"],
  "totalNewTests": 34,
  "totalEstimatedHours": 5,
  "dependencies": ["Sprint 19 - Context-Optimized Retrieval"]
}
